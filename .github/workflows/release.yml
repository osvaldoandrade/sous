name: Auto Release

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: autorelease-main
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      # GitHub Actions doesn't allow referencing `secrets.*` directly in `if:` expressions.
      # We copy it into `env` and check for emptiness via `env.NPM_TOKEN`.
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve next tag
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force

          latest="$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' | sed 's/^v//' | sort -V | tail -n 1 || true)"
          if [ -z "$latest" ]; then
            major=0
            minor=0
            patch=0
          else
            IFS='.' read -r major minor patch <<< "$latest"
          fi

          if ! [[ "$major" =~ ^[0-9]+$ && "$minor" =~ ^[0-9]+$ && "$patch" =~ ^[0-9]+$ ]]; then
            echo "invalid latest tag version: $latest" >&2
            exit 1
          fi

          new_patch=$((patch + 1))
          ver="${major}.${minor}.${new_patch}"
          tag="v${ver}"

          # In case of a re-run or a race, find the next free patch number.
          while git rev-parse "$tag" >/dev/null 2>&1; do
            new_patch=$((new_patch + 1))
            ver="${major}.${minor}.${new_patch}"
            tag="v${ver}"
          done

          echo "ver=$ver" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Test
        run: go test ./...

      - name: Build binaries
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          for GOOS in linux darwin windows; do
            for GOARCH in amd64 arm64; do
              ext=""
              if [ "$GOOS" = "windows" ]; then ext=".exe"; fi
              echo "Building cs $GOOS/$GOARCH"
              CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH" \
                go build -trimpath -ldflags "-s -w" \
                -o "dist/cs-${GOOS}-${GOARCH}${ext}" \
                "./cmd/cs-cli"
            done
          done

      - name: Checksums
        shell: bash
        run: |
          set -euo pipefail
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum dist/* > dist/SHA256SUMS.txt
          else
            shasum -a 256 dist/* > dist/SHA256SUMS.txt
          fi

      - name: Create and push tag
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.vars.outputs.tag }}"
          git tag "$TAG"
          git push origin "$TAG"

      - name: GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.tag }}
          generate_release_notes: true
          files: |
            dist/*

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Prepare npm package version
        shell: bash
        run: |
          set -euo pipefail
          ver="${{ steps.vars.outputs.ver }}"
          cd npm/cs
          npm version "$ver" --no-git-tag-version

      - name: Set up Node (npmjs)
        if: ${{ env.NPM_TOKEN != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Publish npm package (npmjs)
        if: ${{ env.NPM_TOKEN != '' }}
        env:
          NODE_AUTH_TOKEN: ${{ env.NPM_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          cd npm/cs
          npm publish --access public

      - name: Skip npmjs publish (missing NPM_TOKEN)
        if: ${{ env.NPM_TOKEN == '' }}
        shell: bash
        run: |
          echo "NPM_TOKEN is not set; skipping publish to npmjs."
